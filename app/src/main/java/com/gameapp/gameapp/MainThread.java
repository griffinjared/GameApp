package com.gameapp.gameapp;

import android.graphics.Canvas;
import android.util.Log;
import android.view.SurfaceHolder;

import java.util.List;

import gameapp.framework.Input.TouchEvent;

/** The MainThread class keeps the game running once "New Game" is selected from the main menu (the MainActivity)
 * It is generated by the Screen class and runs until the game is over (player dies or wins) or the application quits
 * Here is where the Game States should be created, such as Game, In-Game Menu, and DeathScreen states
 */

public class MainThread extends Thread{

    public static final String TAG = MainThread.class.getSimpleName();

    //Main components
    private SurfaceHolder surfaceHolder;
    private Graphics graphics; //Primary class
    public static Canvas canvas;
    public static Game game;

    //FPS
    private int FPS = 30;
    private double averageFPS;

    private boolean running;

    public void setRunning(boolean running) {
        this.running = running;
    }

    public MainThread(SurfaceHolder surfaceHolder, Graphics graphics) {
        super();
        this.surfaceHolder = surfaceHolder;
        this.graphics = graphics;
        running = true;
    }

    @Override
    public void run() {
        //Variable for keeping track of time and FPS
        long startTime;
        long timeMillis;
        long waitTime;
        long totalTime = 0;
        int frameCount = 0;
        long targetTime = 1000/FPS;
        List<TouchEvent> touchEvents;

        //Others
        long tickCount = 0L;
        Log.d(TAG, "Starting game loop");
        while (running) {
            tickCount++;

            //touchEvents = game.getInput().getTouchEvents();
            startTime = System.nanoTime();
            canvas = null;

            //lock canvas
            try {
                canvas = this.surfaceHolder.lockCanvas(null);
                synchronized (surfaceHolder) {
                    graphics.update();
                    graphics.postInvalidate();
                }
            } catch(Exception e) {}

            finally {
                if (canvas != null) {
                    try {
                        surfaceHolder.unlockCanvasAndPost(canvas);
                    }
                    catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }

            timeMillis = (System.nanoTime() - startTime) / 1000000;
            waitTime = targetTime - timeMillis;

            try {
                sleep(waitTime);
            } catch(Exception e) {}

            totalTime += System.nanoTime();
            frameCount++;

            if (frameCount == FPS) {
                averageFPS = 1000 / (totalTime/frameCount)/1000000;
                frameCount = 0;
                totalTime = 0;
                //Log.d(TAG, "FPS: " + averageFPS);
            }
        }
        Log.d(TAG, "Game loop executed " + tickCount + " times");
    }
}
